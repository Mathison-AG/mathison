// Mathison — Full database schema (Step 02)
// Prisma 7: URL is configured in prisma.config.ts, not here

generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [pgvector(map: "vector", schema: "public")]
}

// ─── Auth & Tenancy ──────────────────────────────────────

model User {
  id                String         @id @default(cuid())
  email             String         @unique
  passwordHash      String?        @map("password_hash")
  name              String?
  role              Role           @default(USER)
  tenantId          String         @map("tenant_id")
  tenant            Tenant         @relation(fields: [tenantId], references: [id])
  activeWorkspaceId       String?        @map("active_workspace_id")
  activeWorkspace         Workspace?     @relation("ActiveWorkspace", fields: [activeWorkspaceId], references: [id])
  onboardingCompletedAt   DateTime?      @map("onboarding_completed_at")
  conversations           Conversation[]
  createdAt               DateTime       @default(now()) @map("created_at")
  updatedAt               DateTime       @updatedAt @map("updated_at")

  @@map("users")
}

enum Role {
  ADMIN
  USER
}

model Tenant {
  id            String         @id @default(cuid())
  slug          String         @unique
  name          String
  status        TenantStatus   @default(ACTIVE)
  users         User[]
  workspaces    Workspace[]
  deployments   Deployment[]
  conversations Conversation[]
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  @@map("tenants")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

model Workspace {
  id          String          @id @default(cuid())
  tenantId    String          @map("tenant_id")
  tenant      Tenant          @relation(fields: [tenantId], references: [id])
  slug        String          // unique within tenant
  name        String
  namespace   String          @unique // K8s namespace: "{tenantSlug}-{workspaceSlug}"
  quota       Json            @default("{}")
  status      WorkspaceStatus @default(ACTIVE)
  deployments Deployment[]
  activeUsers User[]          @relation("ActiveWorkspace")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  @@unique([tenantId, slug])
  @@map("workspaces")
}

enum WorkspaceStatus {
  ACTIVE
  DELETING
  DELETED
}

// ─── Service Catalog ─────────────────────────────────────
// Recipe DB model is slim — only stores dynamic data (install counts, embeddings).
// All static metadata (displayName, config schemas, descriptions, etc.) lives in
// the typed recipe registry at src/recipes/.

model Recipe {
  id            String       @id @default(cuid())
  slug          String       @unique
  installCount  Int          @default(0) @map("install_count")
  featured      Boolean      @default(false)
  embedding     Unsupported("vector(1536)")?
  deployments   Deployment[]
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  @@map("recipes")
}

enum RecipeTier {
  OFFICIAL
  VERIFIED
  COMMUNITY
}

enum RecipeStatus {
  DRAFT
  PUBLISHED
  DEPRECATED
}

// ─── Stacks (bundled recipes) ────────────────────────────

model Stack {
  id          String                    @id @default(cuid())
  slug        String                    @unique
  displayName String                    @map("display_name")
  description String
  services    Json // [{recipeSlug, alias, config, wiring}]
  aiHints     Json                      @default("{}") @map("ai_hints")
  embedding   Unsupported("vector(1536)")?
  tier        RecipeTier                @default(COMMUNITY)
  status      RecipeStatus              @default(DRAFT)
  createdById String?                   @map("created_by_id")
  createdAt   DateTime                  @default(now()) @map("created_at")
  updatedAt   DateTime                  @updatedAt @map("updated_at")

  @@map("stacks")
}

// ─── Deployments ─────────────────────────────────────────

model Deployment {
  id            String           @id @default(cuid())
  tenantId      String           @map("tenant_id")
  tenant        Tenant           @relation(fields: [tenantId], references: [id])
  workspaceId   String           @map("workspace_id")
  workspace     Workspace        @relation(fields: [workspaceId], references: [id])
  recipeId      String           @map("recipe_id")
  recipe        Recipe           @relation(fields: [recipeId], references: [id])
  recipeVersion Int              @map("recipe_version")
  name          String // "my-postgresql"
  namespace     String // workspace's K8s namespace
  config        Json             @default("{}")
  secretsRef    String?          @map("secrets_ref")
  status        DeploymentStatus @default(PENDING)
  url           String?
  localPort     Int?             @map("local_port")     // Port-forward local port
  servicePort   Int?             @map("service_port")   // K8s service port
  serviceName   String?          @map("service_name")   // K8s service name
  appVersion    String?          @map("app_version")    // e.g. "16.2.0"
  managedResources String?       @map("managed_resources") // JSON-serialized K8s resources
  errorMessage  String?          @map("error_message")
  dependsOn     String[]         @map("depends_on") // Deployment IDs
  events        DeploymentEvent[]
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  @@unique([workspaceId, name])
  @@map("deployments")
}

model DeploymentEvent {
  id            String   @id @default(cuid())
  deploymentId  String   @map("deployment_id")
  deployment    Deployment @relation(fields: [deploymentId], references: [id], onDelete: Cascade)
  action        String   // "created", "config_changed", "upgraded", "restarted", "health_changed", "removed"
  previousState Json?    @map("previous_state")
  newState      Json     @map("new_state")
  reason        String?  // "User requested", "Auto-healed", "Dependency updated"
  triggeredBy   String?  @map("triggered_by") // User ID or "system"
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([deploymentId, createdAt])
  @@map("deployment_events")
}

enum DeploymentStatus {
  PENDING
  DEPLOYING
  RUNNING
  FAILED
  STOPPED
  DELETING
}

// ─── Conversations ───────────────────────────────────────

model Conversation {
  id        String    @id @default(cuid())
  tenantId  String    @map("tenant_id")
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id])
  title     String?
  messages  Message[]
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@map("conversations")
}

model Message {
  id              String       @id @default(cuid())
  conversationId  String       @map("conversation_id")
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role            MessageRole
  content         String
  toolInvocations Json?        @map("tool_invocations") // [{toolName, args, result}]
  createdAt       DateTime     @default(now()) @map("created_at")

  @@map("messages")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL
}
