# Step 45 — Ops Agent: Digests & Incident Reports

## Goal

Add daily/weekly infrastructure digests and automatic incident reports. When the agent resolves an issue, it generates a structured incident report. Daily digests summarize overall infrastructure health.

## Prerequisites

- Steps 42–44 complete (health monitoring, version management, backups all functional)

## What to Build

### 1. Daily Digest

`src/lib/ops-agent/digest.ts`:

- `generateDigest(tenantId, period)` — generates a summary covering the last 24h or 7d:
  - App status: X healthy, Y degraded, Z stopped
  - Updates: N applied successfully, M available pending approval
  - Backups: X completed, Y failed, Z overdue
  - Incidents: brief list of issues detected and actions taken
  - Resource trends: any apps approaching resource limits (if metrics available)

- The digest is generated by the LLM — the function gathers raw data and asks Claude to produce a human-readable summary

- Sent via all notification channels configured for each workspace

### 2. Digest Scheduling

In the ops agent scheduler:

- Add a separate repeatable job `OPS_DIGEST` that runs daily at 8:00 AM (configurable)
- Weekly digest option: runs every Monday at 8:00 AM
- Digest interval stored as a workspace-level setting (or tenant-level for MVP)

### 3. Incident Reports

When the agent takes a remediation action (restart, rollback, auto-update), it generates a structured incident report:

```
INCIDENT REPORT — {timestamp}
─────────────────────────────
App: {deployment name}
Workspace: {workspace name}
Severity: {critical/warning}

SYMPTOMS
{What was observed — e.g., "Pod entered CrashLoopBackOff state with 5 restarts in 10 minutes"}

ROOT CAUSE
{Diagnosis from logs/events — e.g., "OOMKilled: container exceeded 256Mi memory limit"}

ACTION TAKEN
{What the agent did — e.g., "Restarted the deployment. Recommend increasing memory_limit to 512Mi."}

CURRENT STATUS
{Result — e.g., "App is now running normally after restart"}

RECOMMENDATION
{Follow-up if needed — e.g., "Consider increasing memory_limit in app settings to prevent recurrence"}
```

- Stored in `OpsAgentRun.actionsJson` with type `"incident_report"`
- Sent via notification channels immediately (not batched)

### 4. Digest Tool

Add to `src/lib/ops-agent/tools.ts`:

**`generateAndSendDigest(tenantId, period)`**
- Gathers data, calls LLM for summary, sends to all workspace channels
- Records as an agent action

### 5. System Prompt for Digests

When running a digest cycle (vs. regular monitoring cycle), the system prompt shifts:
- "Generate a concise infrastructure health report for the user"
- "Focus on what changed since the last report"
- "Highlight anything that needs human attention"
- "Use a friendly, professional tone"
- "Include specific numbers and app names"

### 6. Job Types

Add to `src/lib/queue/jobs.ts`:
- `OPS_DIGEST` job type with data: `{ tenantId: string, period: "daily" | "weekly" }`

## Key Decisions

- Digests are LLM-generated (not template-based) — more natural, can highlight important patterns
- Incident reports are generated immediately when remediation happens (not batched)
- Digest schedule is tenant-level for MVP (all workspaces get the same schedule)
- Digest format is Telegram-friendly (Markdown, concise, emoji for severity)
- The digest job is separate from the regular ops cycle (different schedule, different purpose)

## Testing

1. Trigger a manual digest: verify it summarizes current infrastructure state
2. Deploy an app, break it, let the agent fix it — verify incident report sent via Telegram
3. Verify daily digest schedule fires at configured time
4. Check that digest includes: app counts, update status, backup status, incidents
5. Verify incident report format is readable in Telegram

## Files Changed

- `src/lib/ops-agent/digest.ts` — digest generation
- `src/lib/ops-agent/tools.ts` — digest tool
- `src/lib/ops-agent/loop.ts` — incident report generation in remediation flow
- `src/lib/ops-agent/system-prompt.ts` — digest-specific prompt variant
- `src/lib/ops-agent/scheduler.ts` — digest scheduling
- `src/lib/queue/jobs.ts` — OPS_DIGEST job type
- `worker/main.ts` — handle OPS_DIGEST jobs
