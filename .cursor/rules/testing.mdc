---
description: E2E testing procedures, API curl commands, browser UI verification, full deployment flow testing, cleanup commands, and known test gotchas. Use when testing features, verifying changes, or running the E2E flow.
globs: 
alwaysApply: false
---

# Mathison — E2E Testing Guide

> Verified on 2026-02-13. Repeatable testing procedure for the complete Mathison MVP.

## Quick Start: Full E2E Test

### 1. Infrastructure

```bash
# Docker services (postgres on 5433, redis on 6379)
docker compose -f docker-compose.local.yml ps
# If not running: docker compose -f docker-compose.local.yml up -d

# Kind cluster
kind get clusters                          # → mathison-dev
kubectl cluster-info --context kind-mathison-dev

# Tenant namespace must exist
kubectl --context kind-mathison-dev get ns tenant-mathison-dev
# If missing: kubectl --context kind-mathison-dev create namespace tenant-mathison-dev && \
#             kubectl --context kind-mathison-dev label namespace tenant-mathison-dev mathison.dev/tenant=mathison-dev

# Dev server (check terminals or start fresh)
yarn dev                                   # port 3000

# Worker (MUST be running for deployments to process)
yarn worker                                # separate terminal
```

### 2. Test User

- **Email**: admin@mathison.dev
- **Password**: admin1234
- **Workspace**: mathison-dev
- **Namespace**: tenant-mathison-dev

If the test user doesn't exist:

```bash
curl -s -X POST http://localhost:3000/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@mathison.dev","password":"admin1234","name":"Admin","workspace":"mathison-dev"}'
```

### 3. Database

```bash
# Verify seed data (5 published recipes)
PGPASSWORD=mathison psql -h localhost -p 5433 -U mathison -d mathison \
  -c "SELECT slug, display_name, category FROM recipes ORDER BY slug"

# Re-seed if needed:
yarn db:seed
```

---

## API Testing (curl)

### Authentication

```bash
# Get CSRF token + session cookie
CSRF_RESPONSE=$(curl -s -c /tmp/mathison-cookies.txt http://localhost:3000/api/auth/csrf)
CSRF_TOKEN=$(echo "$CSRF_RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['csrfToken'])")

# Login
curl -s -X POST http://localhost:3000/api/auth/callback/credentials \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -b /tmp/mathison-cookies.txt \
  -c /tmp/mathison-cookies.txt \
  -d "csrfToken=${CSRF_TOKEN}&email=admin@mathison.dev&password=admin1234" \
  -o /dev/null -w "Login: %{http_code}\n" -L

# Verify session
curl -s -b /tmp/mathison-cookies.txt http://localhost:3000/api/auth/session | python3 -m json.tool
# Expected: user with id, tenantId, role, name, email
```

### Catalog API (public, no auth needed)

```bash
# List all recipes
curl -s http://localhost:3000/api/catalog | python3 -c "
import sys, json
data = json.load(sys.stdin)
print(f'Total: {len(data)} recipes')
for r in data: print(f'  {r[\"slug\"]}: {r[\"displayName\"]} ({r[\"category\"]})')
"

# Search
curl -s "http://localhost:3000/api/catalog?search=database" | python3 -c "
import sys, json; [print(r['slug']) for r in json.load(sys.stdin)]
"

# Single recipe
curl -s http://localhost:3000/api/catalog/postgresql | python3 -m json.tool | head -20
```

### Protected APIs (need auth cookie)

```bash
# Deployments list
curl -s -b /tmp/mathison-cookies.txt http://localhost:3000/api/deployments | python3 -m json.tool

# Stack/canvas data
curl -s -b /tmp/mathison-cookies.txt http://localhost:3000/api/stack | python3 -m json.tool

# Unauthenticated → 307 redirect
curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/deployments
# Expected: 307
```

---

## Browser UI Testing

### Dashboard & Canvas

1. Navigate to `http://localhost:3000`
2. If logged in: see Dashboard with canvas
3. Empty state: "Your workspace is empty" with chat CTA
4. With deployments: React Flow canvas shows service nodes
5. Running services: green "Running" badge
6. Deploying: spinner + "Deploying" badge
7. Canvas polls every 5s for status updates

### Catalog

1. Navigate to `/catalog`
2. See 5 recipe cards in grid: MinIO, n8n, PostgreSQL, Redis, Uptime Kuma
3. Category filters: All, Database, Automation, Monitoring, Storage, Analytics
4. Click "Database" → shows PostgreSQL + Redis only
5. Search box filters by text
6. Click a card → navigates to `/catalog/{slug}` detail page
7. Detail shows: icon, name, badges, description, tags, config options, resources
8. "Deploy" button opens chat with pre-filled "Deploy {name}" message

### Chat Panel

1. Click chat FAB (bottom-right) → panel slides open
2. Suggested prompts visible when empty
3. Type message + Enter or click Send
4. AI responds with streaming text
5. Tool invocations show as cards (Catalog Search, Service Details, Deploy Service)
6. Tool cards show status (spinner → green check)
7. Close/reopen preserves chat history (client state)

### Deployments

1. Navigate to `/deployments`
2. Status filters: All, Running, Deploying, Pending, Failed, Stopped
3. Deployment cards show: icon, name, recipe name, time ago, status badge
4. Click card → navigates to `/deployments/{id}` detail page
5. Detail: Overview tab (service, category, created/updated dates)
6. Logs tab: "pending deployment — no logs" or actual pod logs
7. Remove button → confirmation dialog

---

## Full E2E Deployment Flow

### Prerequisites

- All infrastructure running (Docker, kind, dev server, worker)
- Tenant namespace exists in kind cluster
- Images loaded into kind (see "Loading Images" below)

### Test Sequence

1. Open `http://localhost:3000` (logged in as admin@mathison.dev)
2. Open chat panel
3. Type "Deploy Redis" → Send
4. AI agent:
   - Calls `searchCatalog` → finds Redis
   - Calls `getRecipeDetails` → gets config
   - Calls `deployService` → creates deployment + enqueues BullMQ job
5. Canvas shows Redis node with "Pending" → "Deploying" → "Running"
6. Worker logs show: helm install → pods ready → status RUNNING
7. Navigate to `/deployments` → Redis listed with Running status
8. Click Redis → detail page with overview and logs

### Verification Commands

```bash
# K8s pods running
kubectl --context kind-mathison-dev get pods -n tenant-mathison-dev

# Helm release exists
helm list -n tenant-mathison-dev --kube-context kind-mathison-dev

# DB status is RUNNING
PGPASSWORD=mathison psql -h localhost -p 5433 -U mathison -d mathison \
  -c "SELECT name, status FROM deployments"
```

### Loading Images into Kind

```bash
# Pull + load Redis
docker pull bitnami/redis:latest
kind load docker-image bitnami/redis:latest --name mathison-dev

# Pull + load PostgreSQL
docker pull bitnami/postgresql:latest
kind load docker-image bitnami/postgresql:latest --name mathison-dev

# Pull + load MinIO
docker pull bitnami/minio:latest
kind load docker-image bitnami/minio:latest --name mathison-dev
```

### Cleanup Between Tests

```bash
# Remove all deployments from DB
PGPASSWORD=mathison psql -h localhost -p 5433 -U mathison -d mathison \
  -c "DELETE FROM deployments"

# Uninstall all Helm releases
helm list -n tenant-mathison-dev --kube-context kind-mathison-dev -q | \
  xargs -I{} helm uninstall {} -n tenant-mathison-dev --kube-context kind-mathison-dev

# Clean PVCs
kubectl --context kind-mathison-dev delete pvc --all -n tenant-mathison-dev

# Clean BullMQ queue
npx tsx -e "
import { config } from 'dotenv'; config({ path: '.env.local' });
import { Queue } from 'bullmq';
async function clean() {
  const q = new Queue('deployments', { connection: { host: 'localhost', port: 6379 } });
  await q.obliterate({ force: true });
  console.log('Done'); await q.close(); process.exit(0);
}
clean();"
```

---

## Known Issues & Gotchas

| Issue | Details | Workaround |
|-------|---------|------------|
| Worker env loading | Static ES imports hoist above `dotenv.config()` | Worker uses bootstrap pattern: `index.ts` loads env, then dynamically imports `main.ts` |
| Bitnami image tags | Pinned chart versions reference image tags that get removed from Docker Hub | Don't pin `chartVersion` for test recipes, or use `NULL` to get latest |
| Image pull in kind | Kind can't pull from Docker Hub easily | Pre-load images with `kind load docker-image` |
| Card navigation | Fixed — nested `<a>` tags in DeploymentCard, inline Link in RecipeCard | Links now use `className="block"` and inner links replaced with `<span>` + `onClick` |
| Next.js middleware warning | "middleware file convention is deprecated" | Cosmetic only, middleware still works |
| Turbopack root warning | Multiple lockfile detection | Mitigated with `turbopack.root: "."` in next.config.ts |

---

## Typecheck & Lint

Always run after code changes:

```bash
yarn typecheck   # tsc --noEmit
yarn lint         # eslint
```
