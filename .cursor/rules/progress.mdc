---
description: Current project state, environment versions, known issues, architectural decisions log, and feature history. Use at session start or when checking what's been built, what's broken, or what decisions were made.
globs: 
alwaysApply: false
---

# Mathison — Project State

> Read this at the start of every session.

## Current State

- **Phase**: Post-MVP — all 11 build steps complete, E2E tested
- **App directory**: workspace root (not inside `mathison/`)
- **Dev server**: `yarn dev` on port 3000
- **Worker**: `yarn worker` in separate terminal (needed for deployments)
- **Docker services**: postgres on 5433, redis on 6379 (`docker compose -f docker-compose.local.yml up -d`)
- **K8s cluster**: kind `mathison-dev` (K8s v1.35.0)
- **Database**: migrated + seeded — 5 published recipes, pgvector active (v0.8.1)
- **Test user**: admin@mathison.dev / admin1234 (workspace: mathison-dev)

## Environment

| Tool | Version / Path | Notes |
|------|---------------|-------|
| Node.js | v22.22.0 | yarn 1.22.22 |
| Next.js | 16.1.6 | App Router, Turbopack dev |
| Prisma | 7.4.0 | adapter-pg pattern |
| PostgreSQL | 16 (Docker) | port **5433** |
| Redis | 7 (Docker) | port 6379 |
| Helm | v4.1.1 | `/opt/homebrew/bin/helm`, bitnami repo |
| kubectl | system | `/usr/local/bin/kubectl` |
| kind | system | `/opt/homebrew/bin/kind` |
| LLM | Anthropic | API key in .env.local |

## Known Issues

- Turbopack root warning about multiple lockfiles — mitigated with `turbopack.root: "."` in next.config.ts
- Port 5432 occupied by `aucm` project — using 5433
- Next.js 16 deprecation: "middleware" convention deprecated in favor of "proxy" — middleware still works

## Decisions Log

Architectural decisions that affect all future work. Reference by ID when relevant.

| # | Decision | Rationale |
|---|----------|-----------|
| D1 | LLM provider: Anthropic (Claude) | User preference |
| D2 | K8s testing: local `kind` cluster | Disposable, automatable, no shared infra risk |
| D5 | Package manager: yarn | User preference |
| D6 | Prisma 7 with adapter pattern | Latest Prisma; `prisma-client` generator, `@prisma/adapter-pg` |
| D7 | Prisma client output: `src/generated/prisma` | Import from `@/generated/prisma/client` |
| D8 | Postgres port: 5433 | Avoid conflict with existing postgres on 5432 |
| D9 | App at workspace root (not `mathison/`) | Clean layout, single package.json |
| D10 | pgvector 0.8.1, 1536-dim embeddings | Matches text-embedding-3-small output |
| D12 | Split auth config (Edge + full) | Middleware runs in Edge, can't import Prisma |
| D13 | JWT only, no Prisma adapter | Custom user fields, credentials-only auth |
| D14 | bcryptjs (pure JS), 12 salt rounds | No native addon issues |
| D15 | Catalog API routes are public | Write ops check auth in handler |
| D18 | AI SDK v6 API (`inputSchema`, `toUIMessageStreamResponse`, etc.) | Breaking changes from v5 |
| D30 | child_process.execFile for Helm (not execa) | execa v9 ESM-only breaks tsx worker |
| D42 | Cloud-first rebrand: hide K8s terminology from UI | Users see "services" not "Helm charts" |
| D43 | AI SDK v6 UIMessage format | `convertToModelMessages` on server, parts-based rendering on client |
| D56 | Worker bootstrap pattern (index.ts → dynamic import main.ts) | Static imports hoist above dotenv.config() |
| D57 | Bitnami chart versions = NULL (use latest) | Pinned versions reference removed Docker Hub tags |

## Consumer Pivot — Steps 12–20

Target audience shift: from infrastructure engineers to **non-technical consumers** who want to run open-source apps without any technical knowledge. Plan created 2026-02-15.

| Step | Name | Status | Summary |
|------|------|--------|---------|
| 12 | App Data Model | **done** | Enriched Recipe with consumer fields: shortDescription, useCases, gettingStarted, screenshots, websiteUrl, documentationUrl, installCount, featured. All 5 seed recipes enriched. Install count incremented on deploy. |
| 13 | App Store UI | **done** | App Store replaces canvas as homepage. Featured apps section, category-based browsing, search, consumer-friendly cards with "Get" buttons. Detail page redesigned with use cases, getting-started, links. Sidebar: "App Store" + "My Apps". Full consumer language cleanup across all UI components. |
| 14 | One-Click Install | **done** | Install API endpoint, useInstall hook, InstallButton/Modal/Progress/Success components. Cards show "Get" button → confirmation modal → progress → success. Already-installed apps show "Installed" badge. Detail page has inline install flow. Chat no longer required for installs. |
| 15 | My Apps Dashboard | pending | Replace canvas/deployments with consumer-friendly "My Apps" grid. Status indicators, open buttons, settings. |
| 16 | Consumer Agent | pending | Rewrite system prompt + tools for non-technical users. Recommend by problem, diagnose in plain English. |
| 17 | Onboarding | pending | Streamlined signup, welcome flow with category picker, first-install celebration. |
| 18 | App Access & URLs | pending | Auto port-forward for kind, clean URLs, "Open App" button, connection info for databases. |
| 19 | Expanded Catalog | pending | Grow from 5 to 20+ apps. Activepieces, Plane, Outline, Gitea, Nextcloud, Immich, Metabase, Grafana, Vaultwarden, etc. |
| 20 | Consumer Polish | pending | Visual consistency, loading states, error handling, mobile responsiveness, accessibility, language audit. |

Task files: `.cursor/tasks/12-*.md` through `.cursor/tasks/20-*.md`

## Feature Log

Track new features built after MVP. Add entries as you go.

| Date | Feature | Files Changed | Notes |
|------|---------|---------------|-------|
| 2026-02-13 | Multi-workspace support | ~20 files | New Workspace model, workspace CRUD API, sidebar selector, settings management, deployment engine workspace-scoped, AI agent workspace tools. Namespace format: `{tenantSlug}-{workspaceSlug}`. Active workspace via cookie + DB. Migration auto-created default workspaces for existing tenants. |
| 2026-02-17 | Step 12: App Data Model | 7 files | Added 8 consumer-facing fields to Recipe (shortDescription, useCases, gettingStarted, screenshots, websiteUrl, documentationUrl, installCount, featured). Enriched all 5 seed recipes with taglines, use cases, getting-started guides, and website URLs. Added `incrementInstallCount()` in catalog service, called from deployment engine. Migration, types, service, seed script all updated. |
| 2026-02-17 | Step 13: App Store UI | ~15 files | New `src/components/store/` directory with 7 components (app-card, app-grid, featured-apps, category-row, category-filters, store-search, app-detail). Homepage redesigned as App Store with hero/search, featured row, category sections, browse-all grid. Detail page shows use cases, getting-started, links. Sidebar renamed: "App Store" + "My Apps". `/catalog` redirects to `/`. Consumer language cleanup: "Deploy"→"Install", "Service"→"App", "Deploying"→"Installing" across deployments, chat, settings. n8n/Uptime Kuma/MinIO marked as featured. |
| 2026-02-17 | Step 14: One-Click Install | ~13 files | New API route `POST /api/apps/install` wraps deployment engine. `useInstall` hook manages install mutation + 3s polling. 4 new store components: install-button, install-modal (multi-step: confirm → progress → success), install-progress, install-success. App cards show "Get" → modal, "Installed" badge for running apps. Detail page uses inline install flow (no more chat dependency). Store page fetches deployments in parallel for installed-app detection. Auto-naming: slug, slug-2, slug-3 for duplicates. |
