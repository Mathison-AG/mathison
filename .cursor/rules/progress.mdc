---
description: Current project state, environment versions, known issues, architectural decisions log, and feature history. Use at session start or when checking what's been built, what's broken, or what decisions were made.
globs: 
alwaysApply: false
---

# Mathison — Project State

> Read this at the start of every session.

## Current State

- **Phase**: Post-MVP — all 11 build steps complete, E2E tested
- **App directory**: workspace root (not inside `mathison/`)
- **Dev server**: `yarn dev` on port 3000
- **Worker**: `yarn worker` in separate terminal (needed for deployments)
- **Docker services**: postgres on 5433, redis on 6379 (`docker compose -f docker-compose.local.yml up -d`)
- **K8s cluster**: kind `mathison-dev` (K8s v1.35.0)
- **Database**: migrated + seeded — 5 published recipes, pgvector active (v0.8.1)
- **Test user**: admin@mathison.dev / admin1234 (workspace: mathison-dev)

## Environment

| Tool | Version / Path | Notes |
|------|---------------|-------|
| Node.js | v22.22.0 | yarn 1.22.22 |
| Next.js | 16.1.6 | App Router, Turbopack dev |
| Prisma | 7.4.0 | adapter-pg pattern |
| PostgreSQL | 16 (Docker) | port **5433** |
| Redis | 7 (Docker) | port 6379 |
| Helm | v4.1.1 | Host only — removed from Docker containers (Step 22) |
| kubectl | system | `/usr/local/bin/kubectl` |
| kind | system | `/opt/homebrew/bin/kind` |
| LLM | Anthropic | API key in .env.local |

## Known Issues

- Turbopack root warning about multiple lockfiles — mitigated with `turbopack.root: "."` in next.config.ts
- Port 5432 occupied by `aucm` project — using 5433
- Next.js 16 deprecation: "middleware" convention deprecated in favor of "proxy" — middleware still works

## Decisions Log

Architectural decisions that affect all future work. Reference by ID when relevant.

| # | Decision | Rationale |
|---|----------|-----------|
| D1 | LLM provider: Anthropic (Claude) | User preference |
| D2 | K8s testing: local `kind` cluster | Disposable, automatable, no shared infra risk |
| D5 | Package manager: yarn | User preference |
| D6 | Prisma 7 with adapter pattern | Latest Prisma; `prisma-client` generator, `@prisma/adapter-pg` |
| D7 | Prisma client output: `src/generated/prisma` | Import from `@/generated/prisma/client` |
| D8 | Postgres port: 5433 | Avoid conflict with existing postgres on 5432 |
| D9 | App at workspace root (not `mathison/`) | Clean layout, single package.json |
| D10 | pgvector 0.8.1, 1536-dim embeddings | Matches text-embedding-3-small output |
| D12 | Split auth config (Edge + full) | Middleware runs in Edge, can't import Prisma |
| D13 | JWT only, no Prisma adapter | Custom user fields, credentials-only auth |
| D14 | bcryptjs (pure JS), 12 salt rounds | No native addon issues |
| D15 | Catalog API routes are public | Write ops check auth in handler |
| D18 | AI SDK v6 API (`inputSchema`, `toUIMessageStreamResponse`, etc.) | Breaking changes from v5 |
| D30 | child_process.execFile for Helm (not execa) | execa v9 ESM-only breaks tsx worker |
| D42 | Cloud-first rebrand: hide K8s terminology from UI | Users see "services" not "Helm charts" |
| D43 | AI SDK v6 UIMessage format | `convertToModelMessages` on server, parts-based rendering on client |
| D56 | Worker bootstrap pattern (index.ts → dynamic import main.ts) | Static imports hoist above dotenv.config() |
| D57 | Bitnami chart versions = NULL (use latest) | Pinned versions reference removed Docker Hub tags |

## Consumer Pivot — Steps 12–20

Target audience shift: from infrastructure engineers to **non-technical consumers** who want to run open-source apps without any technical knowledge. Plan created 2026-02-15.

| Step | Name | Status | Summary |
|------|------|--------|---------|
| 12 | App Data Model | **done** | Enriched Recipe with consumer fields: shortDescription, useCases, gettingStarted, screenshots, websiteUrl, documentationUrl, installCount, featured. All 5 seed recipes enriched. Install count incremented on deploy. |
| 13 | App Store UI | **done** | App Store replaces canvas as homepage. Featured apps section, category-based browsing, search, consumer-friendly cards with "Get" buttons. Detail page redesigned with use cases, getting-started, links. Sidebar: "App Store" + "My Apps". Full consumer language cleanup across all UI components. |
| 14 | One-Click Install | **done** | Install API endpoint, useInstall hook, InstallButton/Modal/Progress/Success components. Cards show "Get" button → confirmation modal → progress → success. Already-installed apps show "Installed" badge. Detail page has inline install flow. Chat no longer required for installs. |
| 15 | My Apps Dashboard | **done** | New `/apps` route with consumer-friendly grid. Status indicators (Running/Starting/Needs attention/Stopped), app cards with Open/Details + actions menu (Restart, Remove), detail page with getting-started guide + danger zone. Sonner toasts. `/deployments` redirects to `/apps`. Sidebar updated. Restart API wraps `initiateUpgrade()`. Auto-refresh via `["my-apps"]` query invalidation. Dependencies filtered from grid. |
| 16 | Consumer Agent | **done** | System prompt rewritten as friendly concierge. All tools renamed (findApps, installApp, listMyApps, diagnoseApp, etc.). Log diagnosis with plain-English summaries. searchHelmCharts removed. Consumer-friendly result formatting (no pods/namespaces). Updated welcome message and suggested prompts. |
| 17 | Onboarding | **done** | Redesigned signup/login pages (split-screen, password strength, auto-login). Welcome flow with category picker. Onboarding state tracked in DB. First-install confetti celebration. Personalized chat greeting. Improved empty states. |
| 18 | App Access & URLs | **done** | Auto port-forward for kind, clean URLs, smart "Open App" / "Connection Info" button, connection details dialog for databases. Port manager (10000–10999), port-forward health check loop, hasWebUI on Recipe, localPort/servicePort/serviceName on Deployment. |
| 19 | Recipe System Foundation | **done** | Typed recipe system replacing Helm charts. Base types (RecipeDefinition, BuildContext), K8s resource builders, 4 archetypes (database, cache, webApp, objectStore), Server-Side Apply wrapper, all 5 recipes converted to TypeScript modules with Zod config schemas and build() functions, recipe registry with validation. Old Helm engine still works in parallel. |
| 20 | Deployment Engine V2 | **done** | Replaced Helm-based engine with Server-Side Apply. Engine validates config via Zod, calls recipe build(), queues SSA apply jobs. Worker applies/deletes K8s resources directly. Dependencies use recipe connectionInfo(). Secrets generated from typed SecretDefinition. Template rendering (Handlebars) deleted. Job data carries serialized K8s resources instead of Helm values YAML. managedResources field on Deployment model. Headless service builder fix. Bitnami image tags changed to `latest`. |
| 21 | State Model & Audit Trail | **done** | DeploymentEvent model (append-only audit trail). Removed helmRelease/chartVersion/revision from Deployment. Events recorded at deploy, upgrade, restart, removal, health change, failure. New getAppHistory agent tool. All K8s label lookups use deployment name (not Helm release). Workspace deletion uses deleteResources() instead of helmUninstall(). Obsolete backfill script removed. |
| 22 | Agent & Catalog Integration | **done** | Connected typed recipe system to agent tools and catalog API. Recipe DB model slimmed to (slug, installCount, featured, embedding). All static metadata served from recipe registry. Catalog API reads registry + DB. Agent tools validate config against Zod schemas. New previewChanges tool. Deleted seed-data.ts (776 lines), helm.ts, dead catalog components. Removed handlebars dep and Helm from Dockerfile. |
| 23 | Backup & Restore | **done** | Workspace export/import as portable JSON snapshots. Export captures all deployment configs + dependency references (by name). Import validates recipes exist, configs match Zod schemas, deploys in dependency order (topological sort). Secrets never exported (regenerated on restore). API: GET /api/workspaces/:id/export, POST /api/workspaces/:id/import. Agent tools: backupWorkspace, restoreWorkspace. Settings UI: download/upload buttons per workspace. |

| 24 | Data Export & Import | **done** | Per-recipe data portability. New types: DataExportDefinition (command or files strategy), DataImportDefinition. All 5 recipes define export/import (PostgreSQL: pg_dump/psql, Redis: RDB snapshot, MinIO: tar /data, Uptime Kuma: SQLite file, n8n: delegates to dependency DB). kubectl exec utilities (text, stream, stdin). Data export service orchestrates pod discovery + exec. API: POST /api/deployments/:id/export-data (streaming), POST /api/deployments/:id/import-data (file upload). UI: DataExportButton, DataImportButton, Data Management section on detail page. Agent tools: exportAppData, importAppData. |
| 25 | Consumer Polish | **done** | Full QA pass across the consumer experience. Loading skeletons (store detail, settings workspace list). Card hover animations (translateY + shadow lift). Gentle pulse animation for status dots. Error pages (error.tsx for dashboard + apps). Error boundary component. Mobile responsiveness (responsive padding, gap, grid adjustments across all pages). Accessibility (ARIA labels, roles, focus-visible rings, screen reader text on status indicators). Language audit (removed "services", "components", "instance", "deploy" from user-facing strings). Consumer-friendly meta description. Sidebar workspace switch shows toast on error. ~25 files changed. |

Task files: `.cursor/tasks/12-*.md` through `.cursor/tasks/25-*.md`

## Feature Log

Track new features built after MVP. Add entries as you go.

| Date | Feature | Files Changed | Notes |
|------|---------|---------------|-------|
| 2026-02-13 | Multi-workspace support | ~20 files | New Workspace model, workspace CRUD API, sidebar selector, settings management, deployment engine workspace-scoped, AI agent workspace tools. Namespace format: `{tenantSlug}-{workspaceSlug}`. Active workspace via cookie + DB. Migration auto-created default workspaces for existing tenants. |
| 2026-02-17 | Step 12: App Data Model | 7 files | Added 8 consumer-facing fields to Recipe (shortDescription, useCases, gettingStarted, screenshots, websiteUrl, documentationUrl, installCount, featured). Enriched all 5 seed recipes with taglines, use cases, getting-started guides, and website URLs. Added `incrementInstallCount()` in catalog service, called from deployment engine. Migration, types, service, seed script all updated. |
| 2026-02-17 | Step 13: App Store UI | ~15 files | New `src/components/store/` directory with 7 components (app-card, app-grid, featured-apps, category-row, category-filters, store-search, app-detail). Homepage redesigned as App Store with hero/search, featured row, category sections, browse-all grid. Detail page shows use cases, getting-started, links. Sidebar renamed: "App Store" + "My Apps". `/catalog` redirects to `/`. Consumer language cleanup: "Deploy"→"Install", "Service"→"App", "Deploying"→"Installing" across deployments, chat, settings. n8n/Uptime Kuma/MinIO marked as featured. |
| 2026-02-17 | Step 14: One-Click Install | ~13 files | New API route `POST /api/apps/install` wraps deployment engine. `useInstall` hook manages install mutation + 3s polling. 4 new store components: install-button, install-modal (multi-step: confirm → progress → success), install-progress, install-success. App cards show "Get" → modal, "Installed" badge for running apps. Detail page uses inline install flow (no more chat dependency). Store page fetches deployments in parallel for installed-app detection. Auto-naming: slug, slug-2, slug-3 for duplicates. |
| 2026-02-17 | Step 15: My Apps Dashboard | ~18 files | New `src/components/my-apps/` with 5 components (status-indicator, app-card, app-grid, app-detail, remove-dialog). New `/apps` page (grid) + `/apps/[id]` page (server component fetches gettingStarted). New `useMyApps` hook with dependency filtering + auto-polling. Restart API at `/api/deployments/[id]/restart`. Sonner toasts added to providers. `/deployments` and `/deployments/[id]` redirect to `/apps` equivalents. All internal links updated. `["my-apps"]` query invalidation added to install hook + chat provider. |
| 2026-02-17 | Step 16: Consumer Agent | 6 files | System prompt rewritten as friendly app concierge. Tools renamed: findApps, getAppInfo, installApp, listMyApps, getAppStatus, diagnoseApp, changeAppSettings, uninstallApp, requestApp. searchHelmCharts removed. diagnoseApp analyzes logs with plain-English summaries. Consumer result formatting. Tool invocation UI updated. Welcome message and suggested prompts updated. |
| 2026-02-17 | Step 17: Onboarding | ~20 files | Redesigned auth pages (split-screen layout, gradient right panel, app icon showcase). Signup: auto-workspace naming, password strength indicator, auto-login after signup. Login: "Welcome back" heading, forgot password placeholder. Welcome page (`(onboarding)/welcome`) with category picker cards. `onboardingCompletedAt` field on User model. Dashboard layout redirects non-onboarded users. First-install confetti celebration via CSS animation + `useFirstInstall` hook. Personalized chat greeting with user name. Improved empty states (My Apps, Chat). Middleware updated to exclude static assets. |
| 2026-02-17 | Step 18: App Access & URLs | ~15 files | New `port-manager.ts` (DB-backed port assignment 10000–10999) and `port-forward.ts` (kubectl child process management). Worker auto-starts port-forwards on RUNNING, stops on undeploy, health check loop every 60s. `hasWebUI` Boolean on Recipe model. `localPort`/`servicePort`/`serviceName` on Deployment model. Smart `OpenButton` component: web UI apps open in new tab, database apps show `ConnectionInfo` dialog with host, port, credentials, connection string, copy-to-clipboard, show/hide password. New `GET /api/deployments/[id]/access` endpoint reads K8s secrets. Docker compose worker maps port range 10000–10049. Seed data updated with hasWebUI and serviceNameSuffix for all 5 recipes. |
| 2026-02-17 | Step 19: Recipe System Foundation | 16 files | New `src/recipes/` directory. Base types (`RecipeDefinition<TConfig>`, `BuildContext`, `KubernetesResource`), K8s resource builders (statefulSet, deployment, service, secret, pvc, ingress, configMap), 4 archetypes (database, cache, webApp, objectStore), Server-Side Apply wrapper (`applyResources`, `deleteResources`, `dryRunResources`). All 5 recipes converted: PostgreSQL (database archetype), Redis (cache archetype), Uptime Kuma (webApp archetype), MinIO (objectStore archetype), n8n (custom build). Recipe registry with validation. Old Helm engine unchanged — runs in parallel. |
| 2026-02-17 | Step 20: Deployment Engine V2 | 10 files | Replaced Helm engine with Server-Side Apply. Engine rewired: recipe registry lookup → Zod validation → build() → serialize resources → queue job. Worker: applyResources()/deleteResources() instead of helmInstall/helmUninstall. Dependencies use recipe connectionInfo() instead of hardcoded suffixes/ports. Secrets from typed SecretDefinition. Template.ts (Handlebars) deleted. Job data carries serialized K8s resources. New `managedResources` field on Deployment model. Headless service builder fix (clusterIP: None). Bitnami image tags → `latest`. |
| 2026-02-17 | Step 21: State Model & Audit Trail | 18 files | New `DeploymentEvent` model (append-only audit trail). Removed `helmRelease`, `chartVersion`, `revision` from Deployment. New `src/lib/deployer/events.ts` with typed event helpers. Events recorded on deploy/upgrade/restart/removal/health-change/failure. New `getAppHistory` agent tool (last 25 events with human-readable diffs). All K8s label selectors use deployment `name` instead of old Helm release name. Workspace deletion uses `deleteResources()` instead of `helmUninstall()`. kubernetes.ts params renamed. Deployment type + UI cleaned of removed fields. Obsolete `scripts/backfill-versions.ts` deleted. |
| 2026-02-17 | Step 22: Agent & Catalog Integration | ~28 files | Recipe DB model slimmed to 4 fields (slug, installCount, featured, embedding). RecipeVersion model removed. New `src/lib/catalog/metadata.ts` bridges slim DB with recipe registry. All catalog API routes serve registry metadata + DB install counts. All deployment/stack/access API routes select only `recipe.slug`, enrich via `getRecipeMetadataOrFallback()`. Agent tools validate config against Zod schemas before deploy/upgrade. New `previewChanges` tool for dry-run diffs. `requestApp` tool removed. Seed script creates slim DB entries from registry. Deleted: `seed-data.ts` (776 lines), `helm.ts` (621 lines), 3 dead catalog components (393 lines). Removed handlebars dep. Removed Helm from Dockerfile.dev. Net: -2,759 lines deleted, +528 lines added. |
| 2026-02-17 | Step 23: Backup & Restore | 8 files | New `src/types/snapshot.ts` (WorkspaceSnapshot type + Zod schema). New `src/lib/workspace/export.ts` (export workspace to snapshot). New `src/lib/workspace/import.ts` (validate + import with topological sort, cycle detection). New API routes: `GET /api/workspaces/[id]/export` (JSON or file download), `POST /api/workspaces/[id]/import` (with ?force=true option). New agent tools: `backupWorkspace` (export + summary), `restoreWorkspace` (validate + deploy in order, needs approval). Settings UI: download backup + restore from backup buttons per workspace row, import dialog with file picker and force-replace option. |
| 2026-02-17 | Step 24: Data Export & Import | 22 files | Per-recipe data portability. New types: `DataExportDefinition` (command or files strategy), `DataImportDefinition`. All 4 archetypes pass through dataExport/dataImport. All 5 recipes define export/import: PostgreSQL (pg_dump/psql), Redis (RDB), MinIO (tar), Uptime Kuma (SQLite), n8n (delegates to DB). New `pod-exec.ts` (kubectl exec), `data-export.ts` (orchestration). API: `POST /api/deployments/[id]/export-data` (streaming), `POST /api/deployments/[id]/import-data` (upload). UI: DataExportButton, DataImportButton, Data Management section on detail page. Agent tools: `exportAppData`, `importAppData`. |
|| 2026-02-17 | Step 25: Consumer Polish | ~25 files | Full QA pass. CSS: `card-hover`, `animate-gentle-pulse`, `animate-fade-in`. Skeletons for store detail + settings. Error pages for dashboard + apps. Mobile responsive padding/gaps. A11y: ARIA labels, roles, focus-visible rings. Language cleanup: removed technical jargon from all user-facing strings. Sidebar toast on workspace switch error. |
|| 2026-02-18 | Step 30: Production Dockerfile | ~8 files | Multi-stage Dockerfile with three targets: web (250MB), worker (240MB), migrate. Next.js standalone output. Worker bundled with esbuild (ESM, path alias resolution, Prisma/pg external). Pruned Prisma WASM compilers for non-PostgreSQL engines (~100MB saved). kubectl installed only in worker target. Login page Suspense fix for `useSearchParams()`. `.dockerignore` updated. `worker/start.ts` production entry point (no dotenv). |
|| 2026-02-18 | Step 31: Health Check Endpoints | ~5 files | Worker HTTP health server on port 8080 (`/health`). Redis TCP liveness check. `GET /api/health` Next.js route (public, no auth). Middleware + auth config updated to exclude health routes. Docker compose maps port 8080 for worker. |
|| 2026-02-18 | Step 32: K8s Namespace + RBAC | 5 files | New `k8s/base/` directory with plain YAML manifests. `namespace.yaml` (mathison-system), `rbac.yaml` (ServiceAccount + ClusterRole with 13 scoped rules + ClusterRoleBinding), `configmap.yaml` (MATHISON_MODE, NODE_ENV), `secret.yaml` (template with empty placeholders). README with deployment instructions and RBAC summary. All verified against kind cluster — permissions confirmed, no wildcards. |
|| 2026-02-18 | Step 33: K8s PostgreSQL + Redis | 5 files | PostgreSQL 16 + pgvector StatefulSet (10Gi PVC, init script for vector extension, liveness/readiness/startup probes). Redis 7-alpine StatefulSet (1Gi PVC, AOF persistence, allkeys-lru). Each gets headless + ClusterIP services. Secret updated with POSTGRES_PASSWORD. ConfigMap updated with DB host/port/name/user and REDIS_URL. All verified against kind cluster — pods running, pgvector 0.8.1 loaded, data survives pod restarts. |
|| 2026-02-18 | Step 34: K8s Web + Worker + Ingress | 8 files | Migration Job (prisma migrate + seed, 22s). Web Deployment (2 replicas, startup/liveness/readiness probes on /api/health). Worker Deployment (1 replica, health on :8080/health). ClusterIP Service for web on 3000. Ingress with nginx SSE annotations (proxy-buffering off, 300s timeouts, 50m body). ConfigMap updated with LLM_PROVIDER + AUTH_URL. Secret updated with DATABASE_URL. Dockerfile migrate target extended with full src/ for seeding. All verified E2E against kind — migrations, health, catalog API. |
|| 2026-02-18 | Step 35: Tenant App Ingress | 14 files | Environment-aware ingress for tenant apps. When `INGRESS_ENABLED=true` + `MATHISON_BASE_DOMAIN` set, recipe builds produce real K8s Ingress resources with hostname pattern `{app}-{workspace}.apps.{baseDomain}`. Engine computes access URL from Ingress and stores on Deployment.url. Worker skips port-forwarding in production (ingress handles routing). Access API returns ingress URL + K8s internal DNS for database connection strings. Per-recipe SSE/streaming annotations (nginx proxy-buffering off, timeouts). Hostname templates include workspace slug for tenant isolation. TLS via cert-manager (configurable issuer). Local dev mode unchanged (port-forward). |
