---
description:
globs:
alwaysApply: true
---

# Agent Memory

Persistent scratchpad for runtime knowledge. Read every session. Keep it lean — add discoveries, delete what's stale.

---

## Development Environment

- **Docker-first**: All services run via `docker compose -f docker-compose.local.yml up`. No need to install Node.js/yarn on the host.
- **Services**: postgres, redis, setup (migrations/seed), web (Next.js), worker (BullMQ) — all in one compose file.
- **Setup service**: Runs `yarn install`, `prisma generate`, `prisma migrate deploy`, `prisma db seed` on every start. All idempotent.
- **Source code is bind-mounted** (`.:/app`) for hot reloading. `node_modules` uses a named Docker volume (Linux-built deps, avoids macOS conflicts).
- **Kubeconfig**: `~/.kube` is mounted read-only into web + worker. `docker-entrypoint.dev.sh` rewrites `127.0.0.1` → `host.docker.internal` and sets `insecure-skip-tls-verify: true` so containers can reach the kind cluster on the host.
- **Env var override**: Docker `environment:` sets `DATABASE_URL` (postgres:5432) and `REDIS_URL` (redis:6379) for Docker networking. Other vars (API keys, AUTH_SECRET) are loaded from `.env.local` by the apps.
- **After adding deps**: Restart containers (setup service runs `yarn install`). For native module changes: `docker compose -f docker-compose.local.yml up --build`.
- **Full reset**: `docker compose -f docker-compose.local.yml down -v && docker compose -f docker-compose.local.yml up --build`.
- **Running commands**: `docker compose -f docker-compose.local.yml exec web <cmd>` (e.g. `yarn typecheck`, `yarn lint`, `yarn chat "..."`).

## Testing

- **CLI first**: When testing features, use `docker compose -f docker-compose.local.yml exec web yarn chat "..."` instead of the browser. Only use the browser when explicitly told to or when testing UI-specific behavior. The CLI is faster and costs far fewer tokens.
- **CLI supports debug mode**: Add `--debug` to show raw SSE events for debugging stream parsing issues.
- **Auth cookie name**: Auth.js v5 uses `authjs.session-token` (not `next-auth.session-token`).
- **Deployment deletion**: Worker now deletes DB records on successful undeploy (not soft-delete to STOPPED).

## Critical: Things That Will Bite You

- **Prisma 7 import path**: `@/generated/prisma/client` — NOT `@prisma/client`. The old package no longer exports PrismaClient.
- **Prisma 7 adapter required**: Must use `@prisma/adapter-pg` with `pg.Pool`. Pass `adapter` to `new PrismaClient({ adapter })`.
- **Prisma config dotenv**: `prisma.config.ts` must explicitly load `.env.local` via `config({ path: ".env.local" })` — Prisma CLI doesn't auto-load Next.js env files.
- **Postgres port 5433**: Another project occupies 5432. All DATABASE_URL references use 5433.
- **Zod v4 import**: `import { z } from "zod/v4"` — the v4 subpath export. `z.record()` needs 2 args. Error flattening: `z.flattenError(parsed.error)`.
- **Next.js 16 lint**: Uses `eslint .` directly, not `next lint` (which errors in 16.x).
- **execa removed**: Helm wrapper uses `child_process.execFile` (promisified). execa v9 is ESM-only and breaks tsx CJS mode.
- **ioredis removed**: BullMQ bundles its own. Top-level ioredis caused version conflicts.
- **Worker runs outside Next.js**: Must use bootstrap pattern (`index.ts` loads env via dotenv, then dynamic-imports `main.ts`). Static ES imports hoist above dotenv.config().
- **Ollama provider cast**: `ollama-ai-provider` returns LanguageModelV1 but AI SDK v6 expects V3. Cast via `as any as LanguageModelV3`.

## Auth

- **Split config pattern**: `auth.config.ts` (Edge-safe) for middleware + `auth.ts` (full, with Prisma) for server/API. Edge runtime can't import Prisma.
- **Session shape**: `session.user.{id, tenantId, role, name, email}` — augmented via `src/types/next-auth.d.ts`.
- **Auth guard**: `const session = await auth(); if (!session?.user) return 401;`
- **Signup provisions default workspace**: Creates tenant + default workspace + K8s namespace. Fire-and-forget K8s provisioning. Signup still succeeds if K8s unavailable.
- **Test user**: admin@mathison.dev / admin1234, workspace: mathison-dev

## AI SDK v6

- `tool()` uses `inputSchema` (not `parameters`)
- `toUIMessageStreamResponse()` (not `toDataStreamResponse()`)
- `stopWhen: stepCountIs(n)` (not `maxSteps`)
- `useChat` returns `{ messages, sendMessage, status, error, stop }` — NOT `handleSubmit`/`isLoading`
- Manual input state needed — `useChat` v6 doesn't manage it
- `DefaultChatTransport` required: `transport: new DefaultChatTransport({ api: "/api/chat" })`
- Server route: `convertToModelMessages(uiMessages)` before `streamText`
- UIMessage `parts` array (not `content`/`toolInvocations`). Tool part states: `input-available`, `output-available`, `output-error`
- `@ai-sdk/react` v3 is a separate package — not re-exported from `ai`

## Workspaces

- **Workspace model**: Belongs to Tenant, maps to K8s namespace `{tenantSlug}-{workspaceSlug}`.
- **Active workspace**: Resolved via cookie (`mathison-workspace`) → user's `activeWorkspaceId` in DB → first workspace fallback.
- **Workspace context helper**: `getActiveWorkspace(tenantId, userId)` from `@/lib/workspace/context`.
- **Deployments are workspace-scoped**: `Deployment.workspaceId` + unique constraint `[workspaceId, name]`.
- **Deployment engine**: `initiateDeployment()` takes `workspaceId`, looks up `workspace.namespace`.
- **AI agent tools**: `getTools(tenantId, workspaceId)` — 3 workspace tools (list, create, delete) + deployment tools scoped to workspace.
- **Workspace deletion**: Uninstalls Helm releases, deletes K8s namespace, marks deployments STOPPED, reassigns users to another workspace.
- **Cannot delete last workspace**: Enforced in `deleteWorkspace()`.
- **Sidebar workspace selector**: Dropdown in sidebar between brand and nav. Calls `/api/workspaces/switch` + `router.refresh()`.
- **Settings workspace manager**: Full CRUD in `/settings` page with TanStack Query.

## Kubernetes & Helm

- `@kubernetes/client-node` v1.4.0: `_from` not `from` in NetworkPolicyIngressRule (JS reserved word)
- KubeConfig: `loadFromDefault()` for kind/minikube/any. `loadFromCluster()` only as fallback.
- K8s error `statusCode`: 409=already exists, 404=not found. Use for idempotent ops.
- Helm values: write to temp file (os.tmpdir + randomUUID), pass via `--values`, cleanup in `finally`.
- **ALL chart versions use NULL (latest)** for seed recipes — pinned versions reference Docker tags that get removed. This includes Bitnami charts AND the 8gears n8n chart (jumped from 0.26.1 to 2.0.1).
- 8gears n8n chart 2.x: `persistence` moved under `main.persistence`, `valkey` dependency added (disabled by default). Values template updated for 2.x compatibility.
- Bitnami label: `app.kubernetes.io/instance=<releaseName>` for pod queries.
- Kind image loading: `kind load docker-image <image> --name mathison-dev` — essential for testing.

## BullMQ & Deployment Engine

- Queue name: `"deployments"`. Job names from `JOB_NAMES` enum: DEPLOY, UNDEPLOY, UPGRADE, HEALTH_CHECK.
- Connection: plain options `{ host, port, maxRetriesPerRequest: null }` — NOT IORedis instance.
- Engine entry points: `initiateDeployment()`, `initiateUpgrade()`, `initiateRemoval()` from `@/lib/deployer/engine`.
- **Upgrade flow**: `initiateUpgrade()` re-resolves existing deps via `resolveExistingDependencies()` and reuses secrets from K8s via `readK8sSecret()`. Never regenerates secrets on upgrade.
- Values templates: Handlebars with `noEscape: true`. Context: `config`, `secrets`, `deps`, `tenant`, `platform`, `cluster`.
- Custom Handlebars helpers registered: `eq` (block helper for equality checks in templates).
- Template `cluster` context: `domain`, `ingress_class`, `ingress_enabled`, `tls_cluster_issuer` — controlled by env vars `MATHISON_BASE_DOMAIN`, `INGRESS_CLASS`, `INGRESS_ENABLED`, `TLS_CLUSTER_ISSUER`.
- **Resource config**: All recipes expose `cpu_request`, `memory_request`, `cpu_limit`, `memory_limit` in configSchema. Templates use `{{config.cpu_request}}` etc. Users can change resources via `updateService`.
- Dependency auto-deploy: `resolveDependencies()` checks existing, auto-deploys missing. DNS: `<release><suffix>.<namespace>.svc.cluster.local`.
- **Bitnami service name suffixes**: postgresql → `-postgresql`, redis → `-redis-master`, mysql → `-mysql`, mongodb → `-mongodb`, minio → `-minio`. These are appended to the Helm release name for K8s service DNS.
- **Dependency credentials are flattened**: `DependencyInfo` has `host`, `port`, plus all config/secret values at top level. Templates access `{{deps.n8n-db.password}}` directly (not `{{deps.n8n-db.credentials.password}}`).
- **Stale PVC gotcha**: When redeploying with same Helm release name, delete PVCs first — Bitnami PostgreSQL won't reinitialize with new passwords if data directory exists.
- **Port-forward for local access**: `kubectl port-forward svc/<svc-name> <local-port>:<svc-port> -n <ns>` — needed for kind clusters without ingress.

## Frontend Patterns

- **Font**: Inter (not Geist). CSS var `--font-sans`.
- **Providers**: ThemeProvider > QueryClientProvider > TooltipProvider in `src/components/providers.tsx`.
- **Dashboard layout**: `(dashboard)` route group = `/`, `/catalog`, `/deployments`, `/settings`.
- **Theme hydration**: `useSyncExternalStore` for mounted detection (not useState + useEffect).
- **Sheet accessibility**: Add `<SheetTitle className="sr-only">` + `aria-describedby={undefined}`.
- **Chat events**: `chatEvents.openWithMessage(msg)` from `@/lib/events` — cross-component communication.
- **React Flow v12**: Import from `@xyflow/react`. Explicit type params for `useNodesState<Node>([])`.
- **Canvas polling**: TanStack Query `refetchInterval` returns `false` to disable when no transitional states.

## Package Versions

- next@16.1.6, react@19.2.3, react-dom@19.2.3
- prisma@7.4.0, @prisma/client@7.4.0, @prisma/adapter-pg@7.4.0
- zod@4.3.6, ai@6.0.85, @ai-sdk/react@3.0.88
- next-auth@5.0.0-beta.30 (JWT, credentials only)
- @kubernetes/client-node@1.4.0, bullmq@5.69.1
- @xyflow/react@12.10.0, dagre@0.8.5
- react-markdown@10.1.0, handlebars@4.7.8, bcryptjs@3.0.3

## Things to Revisit

- Next.js 16 "proxy" convention replacing "middleware" — monitor for when this becomes required
- `ollama-ai-provider` — check for v2 release supporting LanguageModelV3
- Turbopack root warning about multiple lockfiles — mitigated with `turbopack.root: "."` in next.config.ts
