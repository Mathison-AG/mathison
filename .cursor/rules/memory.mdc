---
description: 
globs: 
alwaysApply: true
---

# Agent Memory

Persistent scratchpad for runtime knowledge. Read every session. Keep it lean — add discoveries, delete what's stale.

---

## Critical: Things That Will Bite You

- **Prisma 7 import path**: `@/generated/prisma/client` — NOT `@prisma/client`. The old package no longer exports PrismaClient.
- **Prisma 7 adapter required**: Must use `@prisma/adapter-pg` with `pg.Pool`. Pass `adapter` to `new PrismaClient({ adapter })`.
- **Prisma config dotenv**: `prisma.config.ts` must explicitly load `.env.local` via `config({ path: ".env.local" })` — Prisma CLI doesn't auto-load Next.js env files.
- **Postgres port 5433**: Another project occupies 5432. All DATABASE_URL references use 5433.
- **Zod v4 import**: `import { z } from "zod/v4"` — the v4 subpath export. `z.record()` needs 2 args. Error flattening: `z.flattenError(parsed.error)`.
- **Next.js 16 lint**: Uses `eslint .` directly, not `next lint` (which errors in 16.x).
- **execa removed**: Helm wrapper uses `child_process.execFile` (promisified). execa v9 is ESM-only and breaks tsx CJS mode.
- **ioredis removed**: BullMQ bundles its own. Top-level ioredis caused version conflicts.
- **Worker runs outside Next.js**: Must use bootstrap pattern (`index.ts` loads env via dotenv, then dynamic-imports `main.ts`). Static ES imports hoist above dotenv.config().
- **Ollama provider cast**: `ollama-ai-provider` returns LanguageModelV1 but AI SDK v6 expects V3. Cast via `as any as LanguageModelV3`.

## Auth

- **Split config pattern**: `auth.config.ts` (Edge-safe) for middleware + `auth.ts` (full, with Prisma) for server/API. Edge runtime can't import Prisma.
- **Session shape**: `session.user.{id, tenantId, role, name, email}` — augmented via `src/types/next-auth.d.ts`.
- **Auth guard**: `const session = await auth(); if (!session?.user) return 401;`
- **Signup provisions default workspace**: Creates tenant + default workspace + K8s namespace. Fire-and-forget K8s provisioning. Signup still succeeds if K8s unavailable.
- **Test user**: admin@mathison.dev / admin1234, workspace: mathison-dev

## AI SDK v6

- `tool()` uses `inputSchema` (not `parameters`)
- `toUIMessageStreamResponse()` (not `toDataStreamResponse()`)
- `stopWhen: stepCountIs(n)` (not `maxSteps`)
- `useChat` returns `{ messages, sendMessage, status, error, stop }` — NOT `handleSubmit`/`isLoading`
- Manual input state needed — `useChat` v6 doesn't manage it
- `DefaultChatTransport` required: `transport: new DefaultChatTransport({ api: "/api/chat" })`
- Server route: `convertToModelMessages(uiMessages)` before `streamText`
- UIMessage `parts` array (not `content`/`toolInvocations`). Tool part states: `input-available`, `output-available`, `output-error`
- `@ai-sdk/react` v3 is a separate package — not re-exported from `ai`

## Workspaces

- **Workspace model**: Belongs to Tenant, maps to K8s namespace `{tenantSlug}-{workspaceSlug}`.
- **Active workspace**: Resolved via cookie (`mathison-workspace`) → user's `activeWorkspaceId` in DB → first workspace fallback.
- **Workspace context helper**: `getActiveWorkspace(tenantId, userId)` from `@/lib/workspace/context`.
- **Deployments are workspace-scoped**: `Deployment.workspaceId` + unique constraint `[workspaceId, name]`.
- **Deployment engine**: `initiateDeployment()` takes `workspaceId`, looks up `workspace.namespace`.
- **AI agent tools**: `getTools(tenantId, workspaceId)` — 3 workspace tools (list, create, delete) + deployment tools scoped to workspace.
- **Workspace deletion**: Uninstalls Helm releases, deletes K8s namespace, marks deployments STOPPED, reassigns users to another workspace.
- **Cannot delete last workspace**: Enforced in `deleteWorkspace()`.
- **Sidebar workspace selector**: Dropdown in sidebar between brand and nav. Calls `/api/workspaces/switch` + `router.refresh()`.
- **Settings workspace manager**: Full CRUD in `/settings` page with TanStack Query.

## Kubernetes & Helm

- `@kubernetes/client-node` v1.4.0: `_from` not `from` in NetworkPolicyIngressRule (JS reserved word)
- KubeConfig: `loadFromDefault()` for kind/minikube/any. `loadFromCluster()` only as fallback.
- K8s error `statusCode`: 409=already exists, 404=not found. Use for idempotent ops.
- Helm values: write to temp file (os.tmpdir + randomUUID), pass via `--values`, cleanup in `finally`.
- Bitnami chart versions: use NULL (latest) for seed recipes — pinned versions reference tags that get removed from Docker Hub.
- Bitnami label: `app.kubernetes.io/instance=<releaseName>` for pod queries.
- Kind image loading: `kind load docker-image <image> --name mathison-dev` — essential for testing.

## BullMQ & Deployment Engine

- Queue name: `"deployments"`. Job names from `JOB_NAMES` enum: DEPLOY, UNDEPLOY, UPGRADE, HEALTH_CHECK.
- Connection: plain options `{ host, port, maxRetriesPerRequest: null }` — NOT IORedis instance.
- Engine entry points: `initiateDeployment()`, `initiateUpgrade()`, `initiateRemoval()` from `@/lib/deployer/engine`.
- Values templates: Handlebars with `noEscape: true`. Context: `config`, `secrets`, `deps`, `tenant`, `platform`.
- Dependency auto-deploy: `resolveDependencies()` checks existing, auto-deploys missing. DNS: `<release>.<namespace>.svc.cluster.local`.

## Frontend Patterns

- **Font**: Inter (not Geist). CSS var `--font-sans`.
- **Providers**: ThemeProvider > QueryClientProvider > TooltipProvider in `src/components/providers.tsx`.
- **Dashboard layout**: `(dashboard)` route group = `/`, `/catalog`, `/deployments`, `/settings`.
- **Theme hydration**: `useSyncExternalStore` for mounted detection (not useState + useEffect).
- **Sheet accessibility**: Add `<SheetTitle className="sr-only">` + `aria-describedby={undefined}`.
- **Chat events**: `chatEvents.openWithMessage(msg)` from `@/lib/events` — cross-component communication.
- **React Flow v12**: Import from `@xyflow/react`. Explicit type params for `useNodesState<Node>([])`.
- **Canvas polling**: TanStack Query `refetchInterval` returns `false` to disable when no transitional states.

## Package Versions

- next@16.1.6, react@19.2.3, react-dom@19.2.3
- prisma@7.4.0, @prisma/client@7.4.0, @prisma/adapter-pg@7.4.0
- zod@4.3.6, ai@6.0.85, @ai-sdk/react@3.0.88
- next-auth@5.0.0-beta.30 (JWT, credentials only)
- @kubernetes/client-node@1.4.0, bullmq@5.69.1
- @xyflow/react@12.10.0, dagre@0.8.5
- react-markdown@10.1.0, handlebars@4.7.8, bcryptjs@3.0.3

## Things to Revisit

- Next.js 16 "proxy" convention replacing "middleware" — monitor for when this becomes required
- `ollama-ai-provider` — check for v2 release supporting LanguageModelV3
- Turbopack root warning about multiple lockfiles — mitigated with `turbopack.root: "."` in next.config.ts
