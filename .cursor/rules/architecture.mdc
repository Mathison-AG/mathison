---
description: Codebase structure, module responsibilities, directory layout, API routes, database models, and data flow. Use when working on features, navigating the codebase, or needing to understand how modules connect.
globs: 
alwaysApply: false
---

# Mathison — Codebase Architecture

> Concise map of the codebase as built. Read this to orient yourself in any session.

## High-Level Data Flow

```
User (browser)
  ↓ chat message
Chat Panel (useChat + AI SDK v6)
  ↓ POST /api/chat
AI Agent (streamText + tools)
  ↓ tool calls (deployService, searchCatalog, etc.)
Deployment Engine (src/lib/deployer/engine.ts)
  ↓ BullMQ job
Worker (worker/main.ts)
  ↓ Helm install/upgrade/uninstall
Kind Cluster (Kubernetes)
```

## Directory Structure

```
ai-k8s/                          # Workspace root = Next.js app
├── src/
│   ├── app/                     # Next.js App Router
│   │   ├── (auth)/              # Login + signup pages (split-screen layout)
│   │   ├── (onboarding)/       # Welcome/first-run flow (minimal layout, auth required)
│   │   ├── (dashboard)/         # Protected pages (/, /catalog, /apps, /deployments→redirect, /settings)
│   │   └── api/                 # API routes
│   │       ├── auth/            # NextAuth + signup
│   │       ├── catalog/         # Public: recipes list, detail, search
│   │       ├── chat/            # AI agent streaming endpoint
│   │       ├── apps/            # One-click install endpoint
│   │       ├── deployments/     # CRUD + logs (workspace-scoped)
│   │       ├── onboarding/      # Mark onboarding complete
│   │       ├── workspaces/      # Workspace CRUD + switch
│   │       └── stack/           # Canvas data (nodes + edges)
│   │
│   ├── components/
│   │   ├── canvas/              # React Flow: stack-canvas, service-node, dependency-edge
│   │   ├── catalog/             # Recipe cards, grid, filters, detail
│   │   ├── store/               # App Store: cards, grid, featured, install flow (modal, progress, success)
│   │   ├── onboarding/          # Welcome categories, first-install celebration
│   │   ├── chat/                # Chat provider, messages, input, tool cards
│   │   ├── my-apps/             # My Apps: app-card, app-grid, app-detail, open-button, connection-info, remove-dialog, status-indicator
│   │   ├── deployments/         # Deployment cards, detail, status badge, log viewer (legacy)
│   │   ├── layout/              # Dashboard shell, sidebar (workspace selector), header, chat panel
│   │   ├── settings/            # Workspace manager component
│   │   ├── ui/                  # shadcn/ui primitives (button, card, sheet, etc.)
│   │   └── providers.tsx        # Client providers (theme, query, tooltip)
│   │
│   ├── recipes/                 # Typed recipe system (replaces Helm values templates)
│   │   ├── _base/               # Foundation: types, builders, archetypes, SSA apply
│   │   ├── postgresql/          # database() archetype
│   │   ├── redis/               # cache() archetype
│   │   ├── uptime-kuma/         # webApp() archetype
│   │   ├── minio/               # objectStore() archetype
│   │   ├── n8n/                 # Custom build() (dependency wiring, worker mode)
│   │   └── registry.ts          # getRecipeDefinition(), listRecipeDefinitions()
│   │
│   ├── lib/
│   │   ├── agent/               # AI: provider factory, system prompt, 10 tools
│   │   ├── catalog/             # Recipes: CRUD service, embeddings, seed data
│   │   ├── cluster/             # K8s client, Helm CLI wrapper, ingress
│   │   ├── deployer/            # Engine, dependency resolution, secrets, templates
│   │   ├── queue/               # BullMQ connection, queue definitions, job types
│   │   ├── tenant/              # Tenant-level operations, quota management
│   │   ├── workspace/           # Workspace CRUD, K8s provisioning, active context
│   │   ├── auth.ts              # Auth.js full config (Prisma, server-side)
│   │   ├── auth.config.ts       # Auth.js Edge config (middleware-safe)
│   │   ├── config.ts            # Zod-validated env vars
│   │   ├── db.ts                # Prisma singleton (adapter-pg)
│   │   ├── events.ts            # Cross-component event emitter (chat ↔ UI)
│   │   └── utils.ts             # cn() and shared utilities
│   │
│   ├── hooks/                   # React hooks: useCanvasData, useCatalog, useDeployments, useInstall
│   ├── types/                   # Shared TypeScript types
│   ├── generated/prisma/        # Generated Prisma client (don't edit)
│   └── middleware.ts            # Auth middleware (Edge runtime)
│
├── worker/
│   ├── index.ts                 # Bootstrap: loads .env.local, dynamic imports main.ts
│   └── main.ts                  # BullMQ worker: processes deploy/undeploy/upgrade jobs
│
├── prisma/
│   ├── schema.prisma            # Database schema (all models, pgvector)
│   ├── seed.ts                  # Seeds 5 recipes (postgresql, redis, n8n, uptime-kuma, minio)
│   └── migrations/              # SQL migrations
│
├── public/icons/                # Service icons (postgresql.svg, redis.svg, etc.)
├── docker-compose.local.yml     # Postgres 16 + Redis 7
├── package.json                 # yarn, scripts: dev, build, worker, typecheck, lint
└── .env.local                   # Environment variables (not committed)
```

## Key Modules

### AI Agent (`src/lib/agent/`)
- **provider.ts** — LLM factory: Anthropic (primary), Ollama (fallback). Returns LanguageModelV3.
- **system-prompt.ts** — Instructions for the agent. Cloud-first language, no K8s terminology. Workspace-aware.
- **tools.ts** — 12 consumer-facing tools. Workspace tools (hidden): `listWorkspaces`, `createWorkspace`, `deleteWorkspace`. App tools (workspace-scoped): `installApp`, `listMyApps`, `getAppStatus`, `diagnoseApp`, `changeAppSettings`, `uninstallApp`. Catalog tools: `findApps`, `getAppInfo`, `requestApp`. Called via `getTools(tenantId, workspaceId)`. All results formatted for consumer context (no pods, namespaces, or config keys).

### Deployment Engine (`src/lib/deployer/`)
- **engine.ts** — `initiateDeployment()`, `initiateUpgrade()`, `initiateRemoval()`. Deployments are workspace-scoped. Engine takes `workspaceId` for deploy, looks up workspace namespace.
- **dependencies.ts** — `resolveDependencies()`. Auto-deploys missing dependencies within the same workspace with priority jobs.
- **secrets.ts** — `generateSecrets()`. Uses `crypto.randomBytes()` for strong secrets.
- **template.ts** — Handlebars rendering. Merges config defaults from recipe's configSchema.

### Cluster Integration (`src/lib/cluster/`)
- **kubernetes.ts** — KubeConfig, namespace CRUD, pod status/logs, resource queries.
- **helm.ts** — Helm CLI wrapper via `child_process.execFile`. Install, upgrade, uninstall, status.
- **ingress.ts** — Ingress rule management.
- **port-manager.ts** — DB-backed local port assignment (range 10000–10999) for port-forwarding.
- **port-forward.ts** — kubectl port-forward child process management. Tracks PIDs, auto-restart on death.

### Background Worker (`worker/`)
- Runs as separate process: `yarn worker` (= `tsx watch worker/index.ts`).
- Processes BullMQ jobs from the `"deployments"` queue.
- Job types: deploy, undeploy, upgrade, health_check.
- Bootstrap pattern: `index.ts` loads dotenv first, then dynamic-imports `main.ts`.
- **Port-forwarding**: Auto-starts port-forwards on RUNNING, stops on undeploy/upgrade. Health check loop every 60s restarts dead forwards. Graceful shutdown stops all forwards.

### Frontend Data Flow
- **TanStack Query** for all client data fetching. Query keys: `["catalog"]`, `["deployments"]`, `["stack"]`.
- **`useChat`** (AI SDK v6 `@ai-sdk/react`) for chat. Sends UIMessage[], server converts to ModelMessage[].
- **Chat invalidation**: ChatProvider invalidates `["deployments"]` + `["stack"]` when chat finishes.
- **Canvas polling**: 5s interval when transitional deployment states exist.

### Auth Flow
- **Middleware** (`middleware.ts`): Edge-safe, uses `auth.config.ts`. Protects all routes except `/login`, `/signup`, `/api/catalog/*`, `/api/auth/*`.
- **Server-side** (`auth.ts`): Full config with Prisma. Used in API routes and server components via `auth()`.
- **JWT sessions**: No database sessions. Token contains `{id, tenantId, role, name, email}`.

## Database Models (Prisma)

| Model | Purpose |
|-------|---------|
| Tenant | Multi-tenancy root. Has slug. Owns workspaces. |
| User | Auth. Belongs to Tenant. Has role (ADMIN/USER), activeWorkspaceId. |
| Workspace | Isolated environment. Belongs to Tenant. Maps to K8s namespace (`{tenantSlug}-{workspaceSlug}`). Has quota, status (ACTIVE/DELETING/DELETED). |
| Recipe | Service template (e.g., PostgreSQL). Has Helm chart info, configSchema, valuesTemplate, hasWebUI |
| RecipeVersion | Version history for recipes |
| Deployment | Running service instance. Belongs to Workspace + Tenant + Recipe. Unique on `[workspaceId, name]`. Has localPort/servicePort/serviceName for port-forwarding. |
| Stack | Groups of deployments (future use) |
| Conversation | Chat thread. Belongs to User + Tenant |
| Message | Chat message. Belongs to Conversation. Has role + content |

## API Routes

| Route | Methods | Auth | Purpose |
|-------|---------|------|---------|
| `/api/auth/[...nextauth]` | GET, POST | Public | Auth.js handlers |
| `/api/auth/signup` | POST | Public | Create tenant + user + default workspace |
| `/api/catalog` | GET | Public | List recipes (with filters) |
| `/api/catalog/[slug]` | GET | Public | Recipe detail |
| `/api/catalog/search` | POST | Public | Semantic search (pgvector) |
| `/api/apps/install` | POST | Protected | One-click install (wraps deployment engine) |
| `/api/chat` | POST | Protected | AI agent streaming (workspace-scoped) |
| `/api/deployments` | GET | Protected | List deployments in active workspace |
| `/api/deployments/[id]` | GET, DELETE | Protected | Deployment detail / remove |
| `/api/deployments/[id]/logs` | GET | Protected | Pod logs |
| `/api/deployments/[id]/access` | GET | Protected | Connection info (credentials, host, port) |
| `/api/workspaces` | GET, POST | Protected | List / create workspaces |
| `/api/workspaces/[id]` | GET, DELETE | Protected | Workspace detail / delete (+ all resources) |
| `/api/workspaces/switch` | POST | Protected | Switch active workspace (sets cookie) |
| `/api/stack` | GET | Protected | Canvas nodes + edges (active workspace) |
